# Conformance Testing

This directory contains conformance tests that compare skia-rs output against the original Skia library.

## Directory Structure

```
conformance/
├── reference/       # Reference images generated by Skia
├── output/          # Images generated by skia-rs
├── diff/            # Visual diff images
├── tests/           # Test case definitions
└── README.md
```

## Running Conformance Tests

### Prerequisites

1. Build the Skia submodule (optional, for generating reference images):
   ```bash
   cd skia
   python3 tools/git-sync-deps
   bin/gn gen out/Release --args='is_official_build=true'
   ninja -C out/Release
   ```

2. Build skia-rs:
   ```bash
   cargo build --release
   ```

### Generate Reference Images

Reference images are generated from the original Skia library:

```bash
# This would run Skia's fiddle or dm tool to generate reference images
./scripts/generate-reference.sh
```

### Generate skia-rs Output

```bash
cargo run --release -p skia-rs-bench --bin conformance_runner
```

### Compare Images

```bash
# Compare all images and generate diff
./scripts/compare-images.sh

# Or use ImageMagick directly
compare -metric RMSE reference/test.png output/test.png diff/test.png
```

## Test Cases

Test cases are defined in `tests/` directory. Each test case is a JSON file:

```json
{
  "name": "basic_rect",
  "description": "Draw a red rectangle",
  "width": 256,
  "height": 256,
  "operations": [
    {
      "type": "clear",
      "color": "#FFFFFF"
    },
    {
      "type": "draw_rect",
      "rect": [10, 10, 100, 100],
      "paint": {
        "color": "#FF0000",
        "style": "fill"
      }
    }
  ]
}
```

## Tolerance Settings

Due to differences in anti-aliasing implementations, some pixel differences are expected:

- **Exact match**: 0% difference (solid fills, no AA)
- **Near match**: < 1% difference (simple AA)
- **Acceptable**: < 5% difference (complex paths, gradients)
- **Review needed**: > 5% difference

## CI Integration

Conformance tests run automatically on:
- Push to `main` branch
- Pull requests to `main`
- Weekly scheduled runs

Results are uploaded as GitHub Actions artifacts.

## Adding New Tests

1. Create a test case JSON file in `tests/`
2. Generate reference image using Skia
3. Run skia-rs to generate output
4. Verify visual correctness
5. Commit all files
